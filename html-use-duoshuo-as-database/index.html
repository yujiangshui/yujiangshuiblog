<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
    <meta name="renderer" content="webkit">
    
    <title>将多说作为静态页面的数据库 | 于江水</title>
    <meta name="description" content="前几天想做一个测试，思路就是获取 UA 并保存然后分析数据。就实现 UA 获取功能做一个 HTML 页面使用 JavaScript 就可以实现了，这样正好可以托管到 Github Pages 上，连服务器都省下了。但实现一个数据存放统计功能，单纯获取信息是不行的，我们还需要一个数据库来存放数据，然后读取分析。 那么问题来了，如何在静态页面上来保存信息、存储数据？ 方法肯定是 AJAX 发送到第三方">
<meta name="keywords" content="duoshuo">
<meta property="og:type" content="article">
<meta property="og:title" content="将多说作为静态页面的数据库">
<meta property="og:url" content="http://yujiangshui.com/html-use-duoshuo-as-database/index.html">
<meta property="og:site_name" content="于江水">
<meta property="og:description" content="前几天想做一个测试，思路就是获取 UA 并保存然后分析数据。就实现 UA 获取功能做一个 HTML 页面使用 JavaScript 就可以实现了，这样正好可以托管到 Github Pages 上，连服务器都省下了。但实现一个数据存放统计功能，单纯获取信息是不行的，我们还需要一个数据库来存放数据，然后读取分析。 那么问题来了，如何在静态页面上来保存信息、存储数据？ 方法肯定是 AJAX 发送到第三方">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-04-10T00:17:52.178Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="将多说作为静态页面的数据库">
<meta name="twitter:description" content="前几天想做一个测试，思路就是获取 UA 并保存然后分析数据。就实现 UA 获取功能做一个 HTML 页面使用 JavaScript 就可以实现了，这样正好可以托管到 Github Pages 上，连服务器都省下了。但实现一个数据存放统计功能，单纯获取信息是不行的，我们还需要一个数据库来存放数据，然后读取分析。 那么问题来了，如何在静态页面上来保存信息、存储数据？ 方法肯定是 AJAX 发送到第三方">
<meta name="twitter:creator" content="@yujiangshui">
<meta property="fb:admins" content="yujiangshui"> 
    <link rel="alternate" href="/atom.xml" title="于江水" type="application/rss+xml">
    

    <link rel="stylesheet" href="//static.zhjan.com/blog/yujiangshui/assets/jiangshui-simple/0.0.1/css/style.css">
    <script data-main="//static.zhjan.com/blog/yujiangshui/assets/jiangshui-simple/0.0.1/js/build" src="//static.zhjan.com/blog/yujiangshui/assets/jiangshui-simple/0.0.1/js/require.js"></script>
    <!--[if lt IE 7]>
      <style>
        .section {
          width: 780px;
        }
        .post-content img {
          width: 100%;
        }
        .jupe pre {
          width: 100%;
        }
      </style>
    <![endif]-->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-57557739-5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-57557739-5');
    </script>
  </head>
</html>

<body>

<div class="section-wrap section-main">
	<div class="section">
		<div class="header">
	<h1 class="logo">
		<a href="/">于江水</a>
	</h1>
	<p class="social-links">
		<a href="http://www.weibo.com/yujiangshui">Weibo</a>
		\
		<a href="https://twitter.com/yujiangshui">Twitter</a>
		\
		<a href="https://github.com/yujiangshui">Github</a>
		\
		<a href="/atom.xml">RSS</a>
	</p>
</div>
		<div class="main">
			<div class="jupe main-body">
  <div class="post-content">
    <h1 class="post-title">将多说作为静态页面的数据库</h1>
    <div class="post-meta">
      <span class="post-time">2015.02.06</span>
      <div class="post-cats">
        <a class="post-cats-item-link" href="/category/others/">其他</a>
      </div>
    </div>
    <div class="post-toc">
      <div class="toc-title">TOC</div>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用多说存储、分析数据"><span class="toc-number">1.</span> <span class="toc-text">使用多说存储、分析数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置多说站点"><span class="toc-number">1.1.</span> <span class="toc-text">配置多说站点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#浏览器端发送数据"><span class="toc-number">1.2.</span> <span class="toc-text">浏览器端发送数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拉取数据进行分析"><span class="toc-number">1.3.</span> <span class="toc-text">拉取数据进行分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于多说开发更多玩意"><span class="toc-number">2.</span> <span class="toc-text">基于多说开发更多玩意</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用多说做博客（Airpub）"><span class="toc-number">2.1.</span> <span class="toc-text">使用多说做博客（Airpub）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用多说做论坛"><span class="toc-number">2.2.</span> <span class="toc-text">使用多说做论坛</span></a></li></ol></li></ol>
    </div>
    <p>前几天想做一个<a href="http://yujiangshui.com/webview-core-test/">测试</a>，思路就是获取 UA 并保存然后分析数据。就实现 UA 获取功能做一个 HTML 页面使用 JavaScript 就可以实现了，这样正好可以托管到 Github Pages 上，连服务器都省下了。但实现一个数据存放统计功能，单纯获取信息是不行的，我们还需要一个数据库来存放数据，然后读取分析。</p>
<p>那么问题来了，如何在静态页面上来保存信息、存储数据？</p>
<p>方法肯定是 AJAX 发送到第三方服务，由于最近在看 Github 的 API 文档，所以考虑在对应 Repo 上创建 Issue 来实现。但是这类 POST 操作，肯定是需要各种权限校验的，Github 当然不例外，实在是太麻烦了，所以寻找其他替代品。Issue 带有评论功能，于是就想到了多说。</p>
<p>看了一下多说 API 的 <a href="http://dev.duoshuo.com/docs/512d6e2e418847315a000001" target="_blank" rel="noopener">发表评论文档</a> 和 <a href="http://dev.duoshuo.com/docs/54460b82f42e54ec03e50082" target="_blank" rel="noopener">获取评论文档</a>，太棒了，正好具备我们需要的功能。可以通过 AJAX 发表评论，评论的内容就是我们需要记录的数据，我们也可以将评论数据拉去下来进行分析。它的权限校验也没有很复杂，只需要发送对应的 Secret ID 即可。</p>
<p>下面就看看具体如何实现。</p>
<h2 id="使用多说存储、分析数据"><a href="#使用多说存储、分析数据" class="headerlink" title="使用多说存储、分析数据"></a>使用多说存储、分析数据</h2><h3 id="配置多说站点"><a href="#配置多说站点" class="headerlink" title="配置多说站点"></a>配置多说站点</h3><p>首先你需要创建一个新站点，无论你之前有没有用过他们的服务，你都应该为测试项目创建一个单独的站点。因为需要使用 Secret ID，并且会暴露在前端被别人看到。</p>
<p>打开<a href="http://duoshuo.com/" target="_blank" rel="noopener">多说首页</a>，点击“我要安装”，会跳转到创建站点界面，填写完成即可创建站点。</p>
<p>之后我们需要创建一篇文章，因为评论是要挂钩到对应文章上面的。在多说后台，找到“文章”标签，手动添加一篇文章，记下关键信息 <code>Thread_Key</code> 即可，其他的随便填下就可以。</p>
<h3 id="浏览器端发送数据"><a href="#浏览器端发送数据" class="headerlink" title="浏览器端发送数据"></a>浏览器端发送数据</h3><p>怎么获取你要保存的数据这里不再赘述，需要注意的就是考虑好数据存储格式，比如是 JSON 字符串等，设计好键值，到时候方便写程序做数据统计和分析。</p>
<p>根据这个 <a href="http://dev.duoshuo.com/docs/512d6e2e418847315a000001" target="_blank" rel="noopener">多说发表评论 API</a>， 我们在浏览器端就是写一个 AJAX 去发送 POST，但是这里面有个跨域提交 POST 的问题，这里我使用 <code>iframe</code> 来解决跨域问题。</p>
<p><code>iframe</code> 跨域其实不能算是 AJAX，它的大体思路就是创建一个 <code>form</code> 表单，<code>method</code> 设置成 <code>POST</code>，<code>action</code> 设置成目标 API 地址，将这个表单提交。因为表单提交会跳转，所以在外面包裹一层 <code>iframe</code>，这样不会影响当前页面，伪造出一种我用过 AJAX 的感觉。</p>
<p><a href="http://www.d-mueller.de/blog/" target="_blank" rel="noopener">David</a> 在 <a href="http://www.d-mueller.de/blog/cross-domain-ajax-guide/" target="_blank" rel="noopener">Cross Domain AJAX Guide</a> 提供了一个很棒的函数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function postIframe(target_url, method, params)&#123;</span><br><span class="line">    //Add iframe</span><br><span class="line">    var iframe = document.createElement(&quot;iframe&quot;);</span><br><span class="line">    document.body.appendChild(iframe);</span><br><span class="line">    iframe.style.display = &quot;none&quot;;</span><br><span class="line">    </span><br><span class="line">    //Give the frame a name</span><br><span class="line">    var frame_name = &quot;frame_name&quot; + (new Date).getTime();</span><br><span class="line">    iframe.contentWindow.name = frame_name;</span><br><span class="line">	</span><br><span class="line">    //build the form</span><br><span class="line">    var form = document.createElement(&quot;form&quot;);</span><br><span class="line">    form.target = frame_name;</span><br><span class="line">    form.action = target_url;</span><br><span class="line">    form.method = method;</span><br><span class="line">	</span><br><span class="line">    //loop through all parameters</span><br><span class="line">    for (var key in params)</span><br><span class="line">    &#123;</span><br><span class="line">        if (params.hasOwnProperty(key))</span><br><span class="line">        &#123;</span><br><span class="line">            var input = document.createElement(&quot;input&quot;);</span><br><span class="line">            input.type = &quot;hidden&quot;;</span><br><span class="line">            input.name = key;</span><br><span class="line">            input.value = params[key];</span><br><span class="line">            form.appendChild(input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    document.body.appendChild(form);</span><br><span class="line">    form.submit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方法很简单，你把要发送的数据保存成 JavaScript object 格式，往里面一丢即可：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var obj = &#123; my_request_is: &quot;foo&quot;, bar: &quot;baz&quot; &#125;;</span><br><span class="line">postIframe(&quot;多说 API URL&quot;, &quot;POST&quot;, obj);</span><br></pre></td></tr></table></figure>
<p>这里要发送的 obj 需要添加一些必要的参数让多说校验，这时候<a href="http://dev.duoshuo.com/docs/512d6e2e418847315a000001" target="_blank" rel="noopener">文档</a>的坑就来了。</p>
<p><code>short_name</code> 中所说的多说二级域名，并不是 <code>jiangshui-test.duoshuo.com</code>，而只是前面部分 <code>jiangshui-test</code>，按常理理解二级域名一般是整个域名。后面多说其他文档有详细提到这一点，但是这里没有。</p>
<p>在请求参数一节，直观的看，必须提交三个参数：<code>short_name</code>、<code>secret</code>、<code>message</code>，但实际上不填写 <code>thread_key</code> 或 <code>thread_id</code> 以及 <code>author_name</code>、<code>author_email</code> 是有前提的，在多说获取到相关信息的情况下可以不写，否则会报错。其中 <code>thread_key</code> 或 <code>thread_id</code> 填写一个即可，<code>author_email</code> 参数如果你在多说后台 “设置” -》“基本设置” 中，勾选掉 “要求游客输入邮件地址” 之后，也可以不发送。</p>
<p>那么你的发送代码差不多这样子：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var result = &#123;&#125;;</span><br><span class="line">result.short_name = &apos;jiangshui-test&apos;;</span><br><span class="line">result.thread_key = &apos;1&apos;;</span><br><span class="line">result.secret = &apos;4ead768a9e5d58******************&apos;;</span><br><span class="line">result.author_name = &apos;testname&apos;;</span><br><span class="line">result.message = JSON.stringify(dataObj);</span><br><span class="line">	</span><br><span class="line">postIframe(&apos;http://api.duoshuo.com/posts/create.json&apos;, &apos;POST&apos;, result);</span><br></pre></td></tr></table></figure>
<h3 id="拉取数据进行分析"><a href="#拉取数据进行分析" class="headerlink" title="拉取数据进行分析"></a>拉取数据进行分析</h3><p>要开始分析数据了，可以通过接口拉取下来，官方后台的工具有导出功能，但导出的不仅仅是评论内容还包括 ID 各种数据。这里我只需要评论内容即可，简单的用 Nodejs 写了个拉取工具 <a href="https://github.com/yujiangshui/pull-duoshuo-data" target="_blank" rel="noopener">pull-duoshuo-data</a>，Nodejs 处理 JSON 非常方便。</p>
<p>此外，在发表评论的时候，多说也会记录一些 UA 等信息，不一定仅仅拉取评论，你可以根据 <a href="http://dev.duoshuo.com/docs/54460b82f42e54ec03e50082" target="_blank" rel="noopener">获取文章评论</a> 文档获取更多信息。</p>
<h2 id="基于多说开发更多玩意"><a href="#基于多说开发更多玩意" class="headerlink" title="基于多说开发更多玩意"></a>基于多说开发更多玩意</h2><p>多说最基础的使用就是做评论、显示评论，本文提供了一个作为临时“数据库”的用法，除此之外还有更多的用法。</p>
<h3 id="使用多说做博客（Airpub）"><a href="#使用多说做博客（Airpub）" class="headerlink" title="使用多说做博客（Airpub）"></a>使用多说做博客（Airpub）</h3><p>郭宇开发的 <a href="http://airpub.io/" target="_blank" rel="noopener">Airpub</a> 是纯前端，基于多说的博客系统。虽然需要发布文章等，但是并不需要 Secret ID 等。简单的看了一下代码，发现开发思路很赞。顺带着咨询多说小武，也了解了更多关于多说开发的细节。</p>
<p>多说会在页面暴露一个名为 <code>DUOSHUO</code> 的全局变量，里面提供了一些方法和当前登录用户信息等。你可以使用这个变量调用更多功能以及获取信息。但是需要注意，这个全局变量的有关说明并没有在官方文档中，因为它没有制定标准规范，可能随时有变化，<strong>慎用</strong>！</p>
<p>使用多说接口发表文章或者评论的时候，多说服务器会根据已登录用户的信息来鉴权。如果你登录了，发表一个评论，虽然你在 POST 接口的时候指定了 <code>author_name</code> 也不将该评论的作者修改成这个指定的名字，而是直接使用登陆后的用户信息。此外，站点的管理员权限的用户，具有向多说同步文章（实现发表文章功能）的权限。</p>
<p>那么 Airpub 的大体思路就是：文章、页面、评论展示当然就是 Get，没有什么问题；拉取站点信息与已登录用户信息（DUOSHUO 里面获取）对比，发现是管理员则显示编辑按钮以及创建文章，发送的时候直接 POST 接口即可，多说服务器会自动鉴权，这样也就不需要 Secret ID 了。</p>
<p>此外，还可以调用显示最近访问某文章的用户（例如<a href="http://blog.wpjam.com/m/js-sdk-4-tips/" target="_blank" rel="noopener">这篇文章</a>下面），为博客增强了社交属性。当然 Airpub 最大的局限就是 SEO 了，同时也不太符合普通博客的操作习惯，难以大面积推广应用。</p>
<p>这种场景要有用户已经登录的前提，如果不需要用户登录就可以进行评论发表，还是需要 Secret ID 的，如果不想暴露，也可以用后端做一个数据转发。</p>
<h3 id="使用多说做论坛"><a href="#使用多说做论坛" class="headerlink" title="使用多说做论坛"></a>使用多说做论坛</h3><p>多说都能做博客了，轻量级的论坛当然也是 OK 的，不过这里需要后端的支持。例如 Denis 随手作的一个轻量级论坛 <a href="http://bbs.wpjam.com/" target="_blank" rel="noopener">http://bbs.wpjam.com/</a>。</p>
<p>最后，特别感谢 @多说小武 帮忙 Review，提供更多开发思路。</p>

  </div>
  <div class="post-share">
	<ul class="share-list">
		<li><a class="icon icon-weibo" href="javascript:share.weibo();"><span>weibo</span></a></li>
		<li><a class="icon icon-twitter" href="javascript:share.twitter();"><span>twitter</span></a></li>
		<li><a class="icon icon-douban" href="javascript:share.douban();"><span>douban</span></a></li>
		<li><a class="icon icon-qzone" href="javascript:share.qzone();"><span>qzone</span></a></li>
	</ul>
</div>
</div>
		</div>
		<div class="footer">
	<p class="left">&copy; Jiangshui 一个努力坚持中低质量原创的<a class="color-egg" href="/images/meinanzi.png">美男子</a>。生活不易，<a href="#">包养本人</a>。</p>
	<p class="right">Base on <a href="https://github.com/yujiangshui/jiangshui-simple">Github</a> and <a href="http://hexo.io/">Hexo</a> .</p>
</div>
	</div>
</div>

</body>
</html>